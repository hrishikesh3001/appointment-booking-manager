<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>com.appointment</groupId>
  <artifactId>appointment-booking-manager</artifactId>
  <version>0.0.1-SNAPSHOT</version>
  <packaging>jar</packaging>

  <name>Appointment Booking Manager</name>
  <description>Desktop application for managing appointments using TDD</description>

  <properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <maven.compiler.source>17</maven.compiler.source>
    <maven.compiler.target>17</maven.compiler.target>

    <!-- Dependencies versions -->
    <junit.version>5.10.1</junit.version>
    <mockito.version>5.8.0</mockito.version>
    <assertj.swing.version>3.17.1</assertj.swing.version>
    <testcontainers.version>1.19.3</testcontainers.version>
    <pitest.version>1.15.3</pitest.version>
    <jacoco.version>0.8.11</jacoco.version>

    <!-- SonarCloud -->
    <sonar.organization>hrishikesh3001</sonar.organization>
    <sonar.projectKey>hrishikesh3001_appointment-booking-manager</sonar.projectKey>
    <sonar.host.url>https://sonarcloud.io</sonar.host.url>
    <sonar.coverage.jacoco.xmlReportPaths>${project.build.directory}/site/jacoco/jacoco.xml</sonar.coverage.jacoco.xmlReportPaths>
    <sonar.coverage.exclusions>**/App.class</sonar.coverage.exclusions>
  </properties>

  <dependencies>
    <!-- JUnit 5 -->
    <dependency>
      <groupId>org.junit.jupiter</groupId>
      <artifactId>junit-jupiter</artifactId>
      <version>${junit.version}</version>
      <scope>test</scope>
    </dependency>

    <!-- Mockito -->
    <dependency>
      <groupId>org.mockito</groupId>
      <artifactId>mockito-core</artifactId>
      <version>${mockito.version}</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.mockito</groupId>
      <artifactId>mockito-junit-jupiter</artifactId>
      <version>${mockito.version}</version>
      <scope>test</scope>
    </dependency>

    <!-- AssertJ Core -->
    <dependency>
      <groupId>org.assertj</groupId>
      <artifactId>assertj-core</artifactId>
      <version>3.24.2</version>
      <scope>test</scope>
    </dependency>

    <!-- AssertJ Swing -->
    <dependency>
      <groupId>org.assertj</groupId>
      <artifactId>assertj-swing-junit</artifactId>
      <version>${assertj.swing.version}</version>
      <scope>test</scope>
    </dependency>

    <!-- Testcontainers Mongo + core + JUnit5 -->
    <dependency>
      <groupId>org.testcontainers</groupId>
      <artifactId>mongodb</artifactId>
      <version>${testcontainers.version}</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.mongodb</groupId>
      <artifactId>mongodb-driver-sync</artifactId>
      <version>4.11.1</version>
    </dependency>
    <dependency>
      <groupId>org.testcontainers</groupId>
      <artifactId>testcontainers</artifactId>
      <version>${testcontainers.version}</version>
      <scope>test</scope>
    </dependency>
    <dependency>
      <groupId>org.testcontainers</groupId>
      <artifactId>junit-jupiter</artifactId>
      <version>${testcontainers.version}</version>
      <scope>test</scope>
    </dependency>
    
    <!-- Simple SLF4J backend for tests (to remove StaticLoggerBinder warnings) -->
    <dependency>
      <groupId>org.slf4j</groupId>
      <artifactId>slf4j-simple</artifactId>
      <version>1.7.36</version>
      <scope>test</scope>
    </dependency>

  </dependencies>

  <build>
    <plugins>
      <!-- Compiler -->
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-compiler-plugin</artifactId>
        <version>3.11.0</version>
        <configuration>
          <source>17</source>
          <target>17</target>
        </configuration>
      </plugin>

      <!-- Register src/it/java and src/e2e/java as test sources -->
      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>build-helper-maven-plugin</artifactId>
        <version>3.5.0</version>
        <executions>
          <execution>
            <id>add-it-and-e2e-sources</id>
            <phase>generate-test-sources</phase>
            <goals><goal>add-test-source</goal></goals>
            <configuration>
              <sources>
                <source>src/it/java</source>
                <source>src/e2e/java</source>
              </sources>
            </configuration>
          </execution>
        </executions>
      </plugin>

      <!-- Surefire: unit tests only -->
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-surefire-plugin</artifactId>
        <version>3.2.3</version>
        <configuration>
          <!-- Allow AssertJ-Swing reflection on JDK 17+ -->
          <argLine>${argLine} --add-opens java.base/java.util=ALL-UNNAMED
                              --add-opens java.base/java.lang=ALL-UNNAMED
                              --add-opens java.desktop/javax.swing=ALL-UNNAMED
                              --add-opens java.desktop/sun.awt=ALL-UNNAMED</argLine>
          <includes>
            <include>**/*Test.java</include>
          </includes>
          <excludes>
            <exclude>**/*IT.java</exclude>
            <exclude>**/*E2E.java</exclude>
       
          </excludes>
        </configuration>
      </plugin>

      <!-- Failsafe: run only *IT (integration tests) by default -->
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-failsafe-plugin</artifactId>
        <version>3.2.3</version>

        <!-- shared config (argLine for Java 17 + Swing) -->
        <configuration>
          <argLine>${argLine} --add-opens java.base/java.util=ALL-UNNAMED
                              --add-opens java.base/java.lang=ALL-UNNAMED
                              --add-opens java.desktop/javax.swing=ALL-UNNAMED
                              --add-opens java.desktop/sun.awt=ALL-UNNAMED</argLine>
        </configuration>

        <executions>
          <execution>
            <id>integration-tests</id>
            <goals>
              <goal>integration-test</goal>
              <goal>verify</goal>
            </goals>
            <configuration>
              <includes>
                <!-- run only IT classes in mvn verify -->
                <include>**/*IT.java</include>
              </includes>
            </configuration>
          </execution>
        </executions>
      </plugin>

      <!-- JaCoCo -->
      <plugin>
  <groupId>org.jacoco</groupId>
  <artifactId>jacoco-maven-plugin</artifactId>
  <version>${jacoco.version}</version>

  <configuration>
    <excludes>
      <exclude>**/App.class</exclude>
      <exclude>**/MongoAppointmentRepository.class</exclude>
    </excludes>
  </configuration>

  <executions>

    <!-- Unit tests agent -->
    <execution>
      <id>prepare-agent</id>
      <goals>
        <goal>prepare-agent</goal>
      </goals>
    </execution>

    <!-- Integration tests agent -->
    <execution>
      <id>prepare-agent-integration</id>
      <goals>
        <goal>prepare-agent-integration</goal>
      </goals>
    </execution>

    <!-- Unit test report -->
    <execution>
      <id>report</id>
      <phase>test</phase>
      <goals>
        <goal>report</goal>
      </goals>
    </execution>

    <!-- Integration test report -->
    <execution>
      <id>report-integration</id>
      <phase>post-integration-test</phase>
      <goals>
        <goal>report-integration</goal>
      </goals>
    </execution>

    <!-- Merge unit + integration exec files -->
    <execution>
      <id>merge-results</id>
      <phase>verify</phase>
      <goals>
        <goal>merge</goal>
      </goals>
      <configuration>
        <fileSets>
          <fileSet>
            <directory>${project.build.directory}</directory>
            <includes>
              <include>jacoco.exec</include>
              <include>jacoco-it.exec</include>
            </includes>
          </fileSet>
        </fileSets>
        <destFile>${project.build.directory}/jacoco-merged.exec</destFile>
      </configuration>
    </execution>

    <!-- FINAL merged report -->
    <execution>
      <id>report-merged</id>
      <phase>verify</phase>
      <goals>
        <goal>report</goal>
      </goals>
      <configuration>
        <dataFile>${project.build.directory}/jacoco-merged.exec</dataFile>
        <outputDirectory>${project.build.directory}/site/jacoco</outputDirectory>
        <formats>
          <format>XML</format>>
          <format>HTML</format>
          <format>CSV</format>
        </formats>
      </configuration>
    </execution>

  </executions>
</plugin>


	<!-- Coveralls -->
    <plugin>
      <groupId>org.eluder.coveralls</groupId>
      <artifactId>coveralls-maven-plugin</artifactId>
      <version>4.3.0</version>
      <dependencies>
        <dependency>
          <groupId>javax.xml.bind</groupId>
          <artifactId>jaxb-api</artifactId>
          <version>2.3.1</version>
        </dependency>
      </dependencies>
    </plugin>

    <!-- PIT -->
	<plugin>
	  <groupId>org.pitest</groupId>
	  <artifactId>pitest-maven</artifactId>
	  <version>${pitest.version}</version>
	  <dependencies>
	    <dependency>
	      <groupId>org.pitest</groupId>
	      <artifactId>pitest-junit5-plugin</artifactId>
	      <version>1.2.1</version>
	    </dependency>
	  </dependencies>
	  <configuration>
	    <!-- mutate only core logic -->
	    <targetClasses>
	      <param>com.appointment.model.*</param>
	      <param>com.appointment.service.*</param>
	      <param>com.appointment.repository.*</param>
	      <param>com.appointment.controller.*</param>
	    </targetClasses>
	
	    <!-- use ONLY core tests as drivers -->
	    <targetTests>
	      <param>com.appointment.model.*Test</param>
	      <param>com.appointment.service.*Test</param>
	      <param>com.appointment.repository.*Test</param>
	      <param>com.appointment.controller.*Test</param>
	    </targetTests>
	
	    <!-- Exclude infrastructure / GUI / main -->
	    <excludedClasses>
	      <param>com.appointment.App</param>
	      <param>com.appointment.view.*</param>
	      <param>com.appointment.repository.MongoAppointmentRepository</param>
	    </excludedClasses>
	
	    <mutators>
	      <mutator>DEFAULTS</mutator>
	    </mutators>
	    <outputFormats>
	      <outputFormat>HTML</outputFormat>
	      <outputFormat>XML</outputFormat>
	    </outputFormats>
	    
	    <mutationThreshold>100</mutationThreshold>
	  </configuration>
	</plugin>


      <!-- Run app locally -->
      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>exec-maven-plugin</artifactId>
        <version>3.1.1</version>
        <configuration>
          <mainClass>com.appointment.App</mainClass>
        </configuration>
      </plugin>
    </plugins>
  </build>
  
  <profiles>
  <profile>
    <id>e2e</id>
    <build>
      <plugins>
        <plugin>
          <groupId>org.apache.maven.plugins</groupId>
          <artifactId>maven-failsafe-plugin</artifactId>
          <version>3.2.3</version>
          <executions>
            <execution>
              <goals>
                <goal>integration-test</goal>
                <goal>verify</goal>
              </goals>
              <configuration>
                <includes>
                  <include>**/*E2E.java</include>
                </includes>
              </configuration>
            </execution>
          </executions>
        </plugin>
      </plugins>
    </build>
  </profile>
  </profiles>
  
</project>
